# Shipping Label Download - Troubleshooting Guide

## Common Issue: 406 Error (Not Acceptable)

### Problem
When trying to download the shipping label, you get a **500 Internal Server Error** with the underlying cause being a **406 Not Acceptable** error from Delhivery's API.

### Root Cause
The 406 error from Delhivery typically means one of the following:

1. **API Token Issues**
   - Token doesn't have permission to access label API
   - Token is expired or invalid
   - Token format is incorrect

2. **Waybill Issues**
   - Waybill number is invalid
   - Label not yet generated by Delhivery
   - Waybill belongs to different account

3. **API Endpoint Issues**
   - Delhivery may have changed their API endpoint
   - API version mismatch
   - Request format not accepted

---

## Solutions Implemented

### 1. Fallback Mechanism
The system now tries multiple methods:

**Method 1**: Direct PDF Download
```
GET https://track.delhivery.com/api/p/packing_slip?wbns={waybill}&pdf=true
```

**Method 2**: HTML Label (if PDF fails)
```
GET https://track.delhivery.com/api/p/packing_slip?wbns={waybill}
```

**Method 3**: Redirect to Delhivery Portal
```
https://www.delhivery.com/track/package/{waybill}
```

### 2. Alternative Access
The modal now shows a direct link to Delhivery Portal where you can:
- View the label
- Download manually
- Print directly

---

## How to Fix

### Option A: Use Delhivery Portal (Recommended for Now)

1. Click "View Shipping Label" button
2. In the modal, click the "Delhivery Portal" link in the blue info box
3. This opens Delhivery's tracking page
4. From there, you can download/print the label

### Option B: Verify API Token Permissions

1. Login to Delhivery Partner Portal
2. Go to API Settings
3. Check if your API token has these permissions:
   - ✅ Create Shipment
   - ✅ Download Label
   - ✅ Schedule Pickup
   - ✅ Track Shipment

4. If not, generate a new token with all permissions
5. Update your `.env` file:
   ```env
   DELHIVERY_API_TOKEN=your_new_token_here
   ```

### Option C: Contact Delhivery Support

If the issue persists, contact Delhivery support with:
- Your API token (first/last 4 characters only)
- Sample waybill number
- Error message: "406 Not Acceptable when accessing packing slip API"
- Request: Confirm correct endpoint for label download

---

## Temporary Workaround

Until the API issue is resolved, you can:

1. **Manual Download from Portal**
   - Use the Delhivery Portal link provided in the modal
   - Bookmark the portal for quick access

2. **Bulk Download**
   - Login to Delhivery Partner Portal
   - Go to "Shipments" section
   - Select multiple shipments
   - Download labels in bulk

3. **Email Labels**
   - Some Delhivery accounts support email delivery of labels
   - Check with your account manager

---

## Testing the Fix

Once you've updated the API token or Delhivery confirms the endpoint:

1. **Test with New Shipment**
   ```
   1. Create a new test order
   2. Generate waybill
   3. Try downloading label
   4. Check browser console for errors
   ```

2. **Check Server Logs**
   ```
   Look for these log messages:
   - "PDF download failed, trying alternative method"
   - "HTML label also failed"
   - Error response details
   ```

3. **Verify Token**
   ```bash
   # Test API token directly
   curl -X GET "https://track.delhivery.com/api/p/packing_slip?wbns=YOUR_WAYBILL&pdf=true" \
     -H "Authorization: Token YOUR_TOKEN" \
     -H "Content-Type: application/json"
   ```

---

## Expected Behavior After Fix

### Success Flow
```
1. Click "View Shipping Label"
   ↓
2. Modal opens with PDF preview
   ↓
3. Click "Download PDF"
   ↓
4. PDF downloads successfully
   ↓
5. Toast: "Shipping label downloaded successfully!"
```

### Fallback Flow (if API still fails)
```
1. Click "View Shipping Label"
   ↓
2. Modal opens (may show loading or error)
   ↓
3. Click "Delhivery Portal" link in blue box
   ↓
4. New tab opens with Delhivery tracking page
   ↓
5. Download label from Delhivery portal
```

---

## API Endpoint Alternatives

If the current endpoint doesn't work, try these alternatives:

### Alternative 1: Manifest API
```
GET https://track.delhivery.com/api/cmu/manifest/
```

### Alternative 2: Waybill Print API
```
GET https://track.delhivery.com/waybill/api/bulk/json/
```

### Alternative 3: Direct Portal URL
```
https://www.delhivery.com/track/package/{waybill}
```

---

## Prevention

To avoid this issue in the future:

1. **Regular Token Rotation**
   - Update API tokens every 90 days
   - Keep backup tokens ready

2. **Monitor API Changes**
   - Subscribe to Delhivery API updates
   - Test endpoints monthly

3. **Fallback Always Available**
   - Always show Delhivery Portal link
   - Don't rely solely on API

4. **Error Logging**
   - Log all API errors
   - Monitor error patterns
   - Alert on repeated failures

---

## Support Contacts

### Delhivery Support
- **Email**: api.support@delhivery.com
- **Phone**: Check your partner portal
- **Portal**: https://www.delhivery.com/partner

### Internal Support
- Check server logs in: `npm run dev` terminal
- Review error messages in browser console (F12)
- Check `.env` file for correct API token

---

## Summary

**Current Status**: Label download may fail due to Delhivery API 406 error

**Workaround**: Use Delhivery Portal link provided in the modal

**Long-term Fix**: 
1. Verify API token permissions
2. Contact Delhivery to confirm correct endpoint
3. Update endpoint if needed

**User Impact**: Minimal - users can still access labels via portal link

---

## Quick Reference

| Issue | Solution |
|-------|----------|
| 406 Error | Use Delhivery Portal link |
| Label not loading | Click "Delhivery Portal" in modal |
| Download fails | Open portal link in new tab |
| Need bulk labels | Login to Delhivery Partner Portal |
| API token invalid | Generate new token with all permissions |

---

**Last Updated**: 2026-01-12  
**Status**: Investigating with Delhivery support  
**ETA for Fix**: Pending Delhivery response
